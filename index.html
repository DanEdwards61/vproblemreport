<!DOCTYPE html>
<html>
<head>
    <title>Problem Log</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>

    <style>
        .log-container {
            width: 100%;
            height: 200px;
            overflow-y: none;
            overflow-x: none;
        }
    </style>
</head>

<body onload="init()">

    <div class="container" ng-app="probReportApp" ng-controller="probReportCtrl">
        <div class="row">
            <div class="col-md-12">
                <h2>Problem Report</h2>
                <hr/>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="form-group">
                    <label for="reportURL">Report URL:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="reportURL" />
                        <div class="input-group-btn">
                            <input type="button" class="btn btn-primary" value="Load" ng-click="getReport(this.value)"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" id='row.log'>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="username">Username</label>
                    <p class="form-control-static" id="username" ng-model="userName"></p>
                </div>
                <div class="form-group">
                    <label for="extension">Extension</label>
                    <p class="form-control-static" id="extension"></p>
                </div>
                <div class="form-group">
                    <label for="platform">Platform</label>
                    <p class="form-control-static" id="platform"></p>
                </div>
                <div class="form-group">
                    <label for="text">Text</label>
                    <p class="form-control-static" id="text"></p>
                </div>
            </div>

            <div class="col-md-8">
                <div class="form-group">
                    <label for="filter">Filter</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="filter" onkeypress="filterPress(event, getElem('filter').value)"/>
                        <div class="input-group-btn">
                            <input type="button" class="btn btn-primary" value="Filter" onclick="filter(getElem('filter').value)"/>
                        </div>
                        <div class="input-group-btn">
                            <input type="button" class="btn btn-primary" value="Clear" onclick="clear_filter()"/>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="log">Log</label>
                    <div class="log-container">
                        <textarea id="log_text" style="width:100%; height:100%;"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div ng-repeat='statset in report.rtcStats'>
            RTC Stat {{statset.key}}
            <div class="row" id='row.rtcStats'>
                <div class="col-md-6">
                    <label for="rtcapi">API Trace</label>
                    <div id='rtcapi' ng-repeat="v in api[statset.key]">
                        {{v[0]}}
                    </div>
                </div>
                <div class="col-md-6">
                    <label for="rtcstat">getStats</label>
                    <div id='rtcstat' ng-repeat="v in stats[statset.key]">
                        {{v[1]}}
                    </div>
                </div>
            </div>
        </div>
    </div>

<script type="text/javascript">

    var app = angular.module('probReportApp', []);
    app.controller('probReportCtrl', function($scope, $http) {
        $scope.report = '';

        $scope.userName = '';

        $scope.active_view = 'log';
        $scope.api = [];
        $scope.stats = [];

        $scope.setStats = function (rtcStats) {
            $scope.api = [];
            $scope.stats = [];
            for( var ndx=0; ndx<rtcStats.length; ndx++ ) {
                var apiList = [];
                var statList = [];

                rtcStats[ndx].value.forEach( (stat) => {
                    if (stat[0] == 'getstats') {
                        statList.push(stat);
                    } else {
                        apiList.push(stat);
                    }
                })
                $scope.api.push(apiList);
                $scope.stats.push(statList);
            }

        }

        $scope.getReport = function() {
            $http.get( "https://api.dev1.vappcenter.com/v1/download/16/6daaff74-9e51-416c-8a10-30d32433807a" )
            .then(function(response) {
                $scope.report = response.data;
                $scope.userName = $scope.report.report.UserName;

                setLog($scope.report.log);

                $scope.setStats($scope.report.rtcStats);
            });
        }

        $scope.show = function(what) {
            active_view = what;
        }
    });


//    var report = JSON.parse(document.getElementById('report').textContent);

    function getElem(id) {
        return document.getElementById(id);
    }

    var header = {
        username: getElem('username'),
        extension: getElem('extension'),
        platform: getElem('platform'),
        text: getElem('text')
    };

    function setHeaders(report) {
//        header.username.innerHTML = report.UserName;
//        header.extension.innerHTML = report.Extension;
//        header.platform.innerHTML = report.Platform;
//        header.text.innerHTML = report.Text;
    }


    function clear_filter() {
        filter('');
        getElem('filter').value = '';
    }

    function filter(str) {

        var regex = new RegExp(str);

        console.log(typeof $scope.report.log);
        var filteredLog = $scope.report.log.filter(function(elem) {
            return regex.test(elem.value.message);
        });

        setLog(filteredLog);
    }

    function filterPress(evt, val) {
        if(evt.keyCode === 13) {
            filter(val);
        }
    }

    var logTextArea = getElem('log_text');

    function setLog(log) {
        var logText = '';
        for(var i = 0; i < log.length; i++) {
            logText = logText + formatLogEntry(log[i]) + '\n';
        }
        logTextArea.innerText = logText;
    }



    function formatTimestamp(ts) {
        var time = new Date(ts);
        return time.toISOString()
            .replace(/T/, ' ')
            .replace(/Z/, ' ' + formatTimestampOffset(time.getTimezoneOffset()));
    }

    function formatTimestampOffset(offset) {
        return offset > 0 ? `-${offset / 60}:00` : `${offset / 60}:00`;
    }

    function formatLogEntry(entry) {
        return '[' + formatTimestamp(entry.value.timestamp) + ' - ' + entry.value.context + '] ' + entry.value.message;
    }

    function init() {
//        setHeaders(report.report);
//        setLog(report.log);
//        document.title = report.report.UserName + '-Problem Report';
    }

</script>
</body>
</html>
